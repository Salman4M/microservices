# Upstream services
upstream auth_service {
    server auth-service:8000;
}

upstream user_service {
    server user-service:8000;
}

upstream shop_service {
    server shop-service:8000;
}

upstream product_service {
    server product-service:8000;
}

upstream order_service {
    server order-service:8000;
}

upstream shopcart_service {
    server shopcart-service:8000;
}

upstream wishlist_service {
    server wishlist-service:8000;
}

# Main server block
server {
    listen 80;
    server_name localhost;

    # CORS headers - applied to all responses
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-User-ID' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

    # ==========================================
    # AUTH SERVICE (No authentication required)
    # ==========================================
    location /api/auth/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Auth service health & docs
    location ~ ^/(health|docs|openapi\.json|redoc)$ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ==========================================
    # USER SERVICE
    # ==========================================
    
    # Public endpoints (no auth required)
    location ~ ^/user/api/user/(login|register|password-reset)/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Protected user endpoints (auth required)
    location /user/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # Extract and validate token
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # ==========================================
    # SHOP SERVICE
    # ==========================================
    
    # Public shop endpoints (GET only, no auth)
    # This handles ONLY GET requests
    location @shop_public {
        proxy_pass http://shop_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }
    
    # Public shop paths - route based on method
    location ~ ^/shop/api/(shops|branches|comments|media|social-media)/(.*)$ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # GET requests go to public handler
        error_page 418 = @shop_public;
        if ($request_method = 'GET') {
            return 418;
        }
        
        # All other methods require auth
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://shop_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # Protected shop endpoints
    location /shop/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://shop_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # ==========================================
    # PRODUCT SERVICE
    # ==========================================
    
    # Public product endpoints (GET only, no auth)
    location @product_public {
        proxy_pass http://product_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }
    
    # Public product paths - route based on method
    location ~ ^/product/api/(categories|products)/(.*)$ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # GET requests go to public handler
        error_page 418 = @product_public;
        if ($request_method = 'GET') {
            return 418;
        }
        
        # All other methods require auth
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://product_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # Protected product endpoints
    location /product/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://product_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # ==========================================
    # ORDER SERVICE (All protected)
    # ==========================================
    location /order/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://order_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # ==========================================
    # SHOPCART SERVICE (All protected)
    # ==========================================
    location /cart/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://shopcart_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # ==========================================
    # WISHLIST SERVICE (All protected)
    # ==========================================
    location /wishlist/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        
        proxy_pass http://wishlist_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header Authorization $http_authorization;
    }

    # ==========================================
    # SWAGGER UI PAGES (Public)
    # ==========================================
    location ~ ^/(user|shop|product|order|cart|wishlist)/(docs|openapi\.json|redoc) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        proxy_pass http://$1_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ==========================================
    # INTERNAL AUTH VALIDATION
    # ==========================================
    location = /auth {
        internal;
        
        # Extract token from Authorization header
        set $token "";
        if ($http_authorization ~* "Bearer (.+)") {
            set $token $1;
        }
        
        # Call auth service to validate
        proxy_pass http://auth_service/api/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Content-Type "application/json";
        
        # Send token in request body
        proxy_set_body '{"token":"$token"}';
        
        # Extract user_id from response
        proxy_set_header X-Original-URI $request_uri;
    }

    # ==========================================
    # ROOT & HEALTH CHECK
    # ==========================================
    location = / {
        return 200 '{"status":"ok","services":["auth","user","shop","product","order","cart","wishlist"],"docs":"/docs"}';
        add_header Content-Type application/json;
    }

    # Nginx metrics for Prometheus
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 172.16.0.0/12;  # Docker network
        deny all;
    }
}