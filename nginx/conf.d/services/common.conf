location ~ ^/(user|shop|product|order|cart|wishlist)/(docs|openapi\.json|redoc) {
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    proxy_pass http://$1_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

# INTERNAL AUTH VALIDATION
location = /auth {
    internal;
    
    # Extract token from Authorization header
    set $token "";
    if ($http_authorization ~* "Bearer (.+)") {
        set $token $1;
    }
    
    # Call auth service to validate
    proxy_pass http://auth_service/api/auth/validate;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Content-Type "application/json";
    
    # Send token in request body
    proxy_set_body '{"token":"$token"}';
    
    # Extract user_id from response
    proxy_set_header X-Original-URI $request_uri;
}